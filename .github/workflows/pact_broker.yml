name: Pact Contract Testing

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  consumer-tests:
    name: Run Consumer Tests & Publish Pact
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Consumer Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.13

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt  # Ensure `pact-python` is included

      - name: Run Consumer Tests & Generate Pact
        run: pytest  # Replace with actual test command

      - name: Publish Pact to Pact Broker
        run: |
          export PACT_BROKER_URL=https://http://54.80.157.126:9292/
          export PACT_BROKER_USERNAME=${{ secrets.PACT_BROKER_USERNAME }}
          export PACT_BROKER_PASSWORD=${{ secrets.PACT_BROKER_PASSWORD }}
          pact-broker publish pacts --broker-base-url $PACT_BROKER_URL --consumer-app-version $GITHUB_SHA

  provider-verification:
    name: Run Provider Verification
    runs-on: ubuntu-latest
    needs: consumer-tests

    steps:
      - name: Checkout Provider Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.10

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt  # Ensure `pact-python` is included

      - name: Run Provider Verification
        run: |
          export PACT_BROKER_URL=https://http://54.80.157.126:9292/
          export PACT_BROKER_USERNAME=${{ secrets.PACT_BROKER_USERNAME }}
          export PACT_BROKER_PASSWORD=${{ secrets.PACT_BROKER_PASSWORD }}
          pytest --pact-broker-url=$PACT_BROKER_URL  # Modify based on your verification setup

  pact-verification:
    name: Mark Pact as Verified
    runs-on: ubuntu-latest
    needs: provider-verification

    steps:
      - name: Mark Pact as Verified in Pact Broker
        run: |
          export PACT_BROKER_URL=https://your-pact-broker.com
          export PACT_BROKER_USERNAME=${{ secrets.PACT_BROKER_USERNAME }}
          export PACT_BROKER_PASSWORD=${{ secrets.PACT_BROKER_PASSWORD }}
          pact-broker can-i-deploy --pacticipant "Provider" --latest --to "production"
