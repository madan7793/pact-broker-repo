name: Pact Broker Setup with Consumer and Provider on Docker

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy and Test Pact Broker, Consumer, and Provider
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Docker Compose (if not available)
        run: |
          if ! command -v docker-compose &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y docker-compose
          fi

      - name: Start Services with Docker Compose
        run: docker compose up -d

      - name: List Running Docker Containers
        run: docker ps -a

      - name: Wait for Services to Start
        run: sleep 30

      - name: Verify Pact Broker is Running
        run: curl -f http://localhost:9292 || (echo "Pact Broker failed to start" && exit 1)

      - name: Verify Consumer Service is Running
        run: |
          curl -f http://localhost:3000 || (echo "Consumer service failed to start" && docker logs consumer-service && exit 1)

      - name: Verify Provider Service is Running
        run: |
          curl -f http://localhost:4000 || (echo "Provider service failed to start" && docker logs provider-service && exit 1)

      - name: Run Consumer Pact Tests
        run: docker exec consumer-service npm test

      - name: Publish Pact Contracts to Pact Broker
        run: |
          docker exec consumer-service npx pact-cli publish /pacts \
            --consumer-app-version=$(git rev-parse --short HEAD) \
            --broker-base-url=http://pact-broker:9292

      - name: Run Provider Verification Against Pact Broker
        run: docker exec provider-service npm test

      - name: Cleanup Docker Containers
        if: always()
        run: docker compose down

      - name: Output Service URLs
        run: |
          echo "Pact Broker is running at http://localhost:9292"
          echo "Consumer Service is running at http://localhost:3000"
          echo "Provider Service is running at http://localhost:4000"
