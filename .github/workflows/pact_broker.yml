---
name: test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

env:
  STABLE_PYTHON_VERSION: '3.13'
  PYTEST_ADDOPTS: --color=yes
  HATCH_VERBOSE: '1'
  FORCE_COLOR: '1'
  PACT_BROKER_URL: 'http://pact-lb-1820998503.us-east-1.elb.amazonaws.com'

jobs:
  complete:
    name: Test completion check
    if: always()

    permissions:
      contents: none

    runs-on: ubuntu-latest
    needs:
      - test-linux
      - example
      - format
      - lint
      - typecheck
      - spelling
      - pre-commit

    steps:
      - name: Check for Failed Jobs
        run: |
          for job in "${{ join(needs.*.result, ' ') }}"; do
            if [[ "$job" == "failure" || "$job" == "cancelled" || "$job" == "skipped" ]]; then
              echo "A required job failed, cancelling workflow."
              exit 1
            fi
          done

  test-linux:
    name: Test Python ${{ matrix.python-version }} on Linux
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
    
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5

      - name: Install Python
        run: uv python install ${{ matrix.python-version }}

      - name: Install Dependencies
        run: uv tool install hatch

      - name: Run Tests
        run: hatch run test --broker-url=${{ env.PACT_BROKER_URL }} --container

      - name: Upload Coverage
        if: matrix.python-version == env.STABLE_PYTHON_VERSION
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: tests

  example:
    name: Run Example
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv python install ${{ env.STABLE_PYTHON_VERSION }}
      - run: uv tool install hatch
      - run: hatch run example --broker-url=${{ env.PACT_BROKER_URL }}
      - uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: examples

  format:
    name: Code Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv python install ${{ env.STABLE_PYTHON_VERSION }}
      - run: uv tool install hatch
      - run: hatch run format

  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv python install ${{ env.STABLE_PYTHON_VERSION }}
      - run: uv tool install hatch
      - run: hatch run lint

  typecheck:
    name: Type Checking
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv python install ${{ env.STABLE_PYTHON_VERSION }}
      - run: uv tool install hatch
      - run: hatch run typecheck

  spelling:
    name: Spell Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: crate-ci/typos@v1.29.7

  pre-commit:
    name: Run Pre-commit Hooks
    runs-on: ubuntu-latest
    env:
      PRE_COMMIT_HOME: ${{ github.workspace }}/.pre-commit
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: ${{ env.PRE_COMMIT_HOME }}
          key: ${{ runner.os }}-pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
      - uses: astral-sh/setup-uv@v5
      - run: uv tool install pre-commit
      - run: pre-commit run --show-diff-on-failure --color=always --all-files
